{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}
    {% if media %}
        Edit {{ media.get_media_type_display }}
    {% else %}
        Add {{ media_type_choices|dict_key:media_type }}
    {% endif %}
{% endblock %}

{% block content %}
<div class="media-form-page">
    <h1>
        {% if media %}
            Edit {{ media.get_media_type_display }}
        {% else %}
            Add {{ media_type_choices|dict_key:media_type }}
        {% endif %}
    </h1>

    <!-- Main Media Form -->
    <form method="POST" action="{% if media %}{% url 'edit_media' media.id %}{% else %}{% url 'add_media_by_type' media_type %}{% endif %}">
        {% csrf_token %}

        <!-- Hidden Media Type Field -->
        <input type="hidden" id="media_type" name="media_type" value="{{ media.media_type|default:media_type }}">

        <!-- Title Field with dynamic RAWG fetch using datalist -->
        <div class="form-group">
            <label for="title">Title</label>
            <input type="text" id="title" name="title" value="{{ form.initial.title|default_if_none:'' }}" required list="title-suggestions" oninput="fetchMediaSuggestions()">
            <datalist id="title-suggestions"></datalist> <!-- Datalist for the dropdown suggestions -->
        </div>

        <!-- Rating Field -->
        <div class="form-group">
            <label for="rating">Rating</label>
            <input type="number" id="rating" name="rating" value="{{ form.initial.rating|default_if_none:'' }}" min="1" max="5" required>
        </div>

        <!-- Status Field -->
        <div class="form-group">
            <label for="status">Status</label>
            <select id="status" name="status" required>
                <option value="" disabled {% if not media.status %}selected{% endif %}>Select Status</option>
                <option value="f" {% if media.status == 'f' %}selected{% endif %}>Finished</option>
                <option value="ip" {% if media.status == 'ip' %}selected{% endif %}>In Progress</option>
                <option value="p" {% if media.status == 'p' %}selected{% endif %}>Plan to Watch</option>
                <option value="dr" {% if media.status == 'dr' %}selected{% endif %}>Dropped</option>
            </select>
        </div>

        <!-- Genre Fields -->
        <div class="form-group">
            <label for="genre">Genre</label>
            <input type="text" id="genre" name="genre" value="{{ form.initial.genre|default_if_none:'' }}">
        </div>

        {% if media_type == 'game' %}
        <div class="form-group">
            <label for="difficulty">Difficulty (optional)</label>
            <select id="difficulty" name="difficulty">
                <option value="" disabled selected>Select Difficulty</option>
                {% for choice in DIFFICULTY_CHOICES %}
                    <option value="{{ choice.0 }}">{{ choice.1 }}</option>
                {% endfor %}
            </select>
        </div>
        {% endif %}

        <!-- Description Fields -->
        <div class="form-group">
            <label for="description">Description</label>
            <textarea id="description" name="description">{{ form.initial.description|default_if_none:'' }}</textarea>
        </div>

        <!-- Hidden Image URL Field -->
        <input type="hidden" id="image_url" name="image_url" value="{{ form.initial.image_url|default_if_none:'' }}">

        <!-- Favorite Checkbox -->
        <div class="form-group">
            <label for="is_favorite">Favorite?</label>
            <input type="checkbox" id="is_favorite" name="is_favorite" {% if media.is_favorite %}checked{% endif %}>
        </div>

        <!-- Notes Field -->
        <div class="form-group">
            <label for="notes">Notes (optional)</label>
            <textarea id="notes" name="notes">{{ media.notes|default_if_none:'' }}</textarea>
        </div>

        <!-- Submit Button -->
        <div class="form-group">
            <button type="submit" class="submit-btn">Submit</button>
        </div>
    </form>

    <div>
        <script>
            let debounceTimeout;

            function fetchMediaSuggestions() {
                const titleInput = document.getElementById('title').value;
                const mediaType = document.getElementById('media_type').value;
                const datalist = document.getElementById('title-suggestions');

                if (titleInput.length < 3) {
                    datalist.innerHTML = ''; // Clear suggestions if input is less than 3 characters
                    return;
                }

                // Debounce to prevent too many API calls
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(() => {
                    if (mediaType === 'game') {
                        // Fetch from RAWG API for games
                        fetchRawgSuggestions(titleInput);
                    } else {
                        // Fetch from OMDB API for movies/TV shows
                        fetchOMDBSuggestions(titleInput);
                    }
                }, 300); // Delay the fetch by 300ms to reduce API calls
            }

            function fetchRawgSuggestions(title) {
                const datalist = document.getElementById('title-suggestions');
            
                fetch(`/fetch_rawg_data/?query=${encodeURIComponent(title)}`)
                    .then(response => {
                        if (!response.ok) throw new Error('Network response was not ok');
                        return response.json();
                    })
                    .then(data => {
                        datalist.innerHTML = ''; // Clear previous suggestions
            
                        if (data.results && data.results.length > 0) {
                            data.results.forEach(item => {
                                const option = document.createElement('option');
                                option.value = item.name; // Use 'name' for the title
                                datalist.appendChild(option);   
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching data from RAWG:', error);
                    });
            }
            
            function fetchRawgData(title) {
                fetch(`/fetch_rawg_data/?query=${encodeURIComponent(title)}`)
                    .then(response => {
                        if (!response.ok) throw new Error('Network response was not ok');
                        return response.json();
                    })
                    .then(data => {
                        if (data.results && data.results.length > 0) {
                            const game = data.results[0];
                            document.getElementById('genre').value = game.genres.map(genre => genre.name).join(', ') || '';
                            document.getElementById('description').value = game.description_raw || game.description || 'No description available';
                            document.getElementById('image_url').value = game.background_image || '';
                        } else {
                            console.error('No game found in the response.');
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching data from your server:', error);
                    });
            }
            

            function fetchOMDBSuggestions(title) {
                const omdbApiKey = '{{ omdb_api_key }}';
                const datalist = document.getElementById('title-suggestions');

                fetch(`https://www.omdbapi.com/?s=${encodeURIComponent(title)}&apikey=${omdbApiKey}`)
                    .then(response => {
                        if (!response.ok) throw new Error('Network response was not ok');
                        return response.json();
                    })
                    .then(data => {
                        datalist.innerHTML = ''; // Clear previous suggestions

                        if (data.Response === "True") {
                            data.Search.forEach(item => {
                                const option = document.createElement('option');
                                option.value = item.Title;
                                datalist.appendChild(option);
                            });
                        } else {
                            console.error('No suggestions found.');
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching data from OMDB:', error);
                    });
            }

            function fetchOMDBData(title) {
                const omdbApiKey = '{{ omdb_api_key }}';

                fetch(`https://www.omdbapi.com/?t=${encodeURIComponent(title)}&apikey=${omdbApiKey}`)
                    .then(response => {
                        if (!response.ok) throw new Error('Network response was not ok');
                        return response.json();
                    })
                    .then(data => {
                        if (data.Response === "True") {
                            document.getElementById('genre').value = data.Genre || '';
                            document.getElementById('description').value = data.Plot || '';
                            document.getElementById('image_url').value = data.Poster || '';
                        } else {
                            console.error('Media not found:', data.Error);
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching data from OMDB:', error);
                    });
            }

            // Attach event listeners
            document.getElementById('title').addEventListener('input', () => {
                fetchMediaSuggestions();
            });

            document.getElementById('media_type').addEventListener('change', () => {
                fetchMediaSuggestions(); // Re-fetch suggestions when media type changes
            });

            // Listen for selection of an option from the datalist
            document.getElementById('title').addEventListener('change', () => {
                const selectedTitle = document.getElementById('title').value;
                const mediaType = document.getElementById('media_type').value;
                
                if (mediaType === 'game') {
                    fetchRawgData(selectedTitle);
                } else {
                    fetchOMDBData(selectedTitle);
                }
            });
        </script>
    </div>
</div>
{% endblock %}
